<div class="order-page container-fluid py-3">

  <!-- Header -->
  <div class="page-header card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="title">Order Management</h3>
        <p class="subtitle">Track, manage and update orders with real-time status</p>
      </div>

      <button class="btn refresh-btn" (click)="loadOrders()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="row g-3 stats-row">

    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box bg-orders">
        <i class="bi bi-cart-check icon"></i>
        <div class="value">{{ totalItems() }}</div>
        <div class="label">Orders</div>
      </div>
    </div>

    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box bg-pending">
        <i class="bi bi-clock icon"></i>
        <div class="value">{{ pending }}</div>
        <div class="label">Pending</div>
      </div>
    </div>

    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box bg-confirmed">
        <i class="bi bi-gear icon"></i>
        <div class="value">{{ confirmed }}</div>
        <div class="label">Confirmed</div>
      </div>
    </div>

    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box bg-delivered">
        <i class="bi bi-check-circle icon"></i>
        <div class="value">{{ delivered }}</div>
        <div class="label">Delivered</div>
      </div>
    </div>

    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box bg-cancelled">
        <i class="bi bi-x-circle icon"></i>
        <div class="value">{{ cancelled }}</div>
        <div class="label">Cancelled</div>
      </div>
    </div>

  </div>

  <!-- Main Card -->
  <div class="card modern-card mt-4">

    <div class="card-body">

      <!-- Loading -->
      @if (loading()) {
        <div class="loading-container">
          <div class="spinner-border text-primary"></div>
        </div>
      }

      <!-- Error -->
      @if (error()) {
        <div class="alert alert-danger text-center">{{ error() }}</div>
      }

      @if (!loading() && !error()) {
      <!-- Modern Filters Panel -->
      <div class="filters-wrapper">

        <div class="filters-grid">
          <!-- Search -->
          <div class="filter-item">
            <label>Search</label>
          <div class="search-box">
            <i class="bi bi-search search-icon"></i>
            <input
              type="text"
              class="filter-input"
              placeholder="Search Order #, Name, Email..."
              [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event)"
            />
          </div>
           </div>
          

          <!-- Order Status -->
          <div class="filter-item">
            <label>Order Status</label>
            <select
              class="filter-select"
              [ngModel]="statusFilter()"
              (ngModelChange)="statusFilter.set($event)"
            >
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="packed">Packed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <!-- Delivery Status -->
          <div class="filter-item">
            <label>Delivery Status</label>
            <select
              class="filter-select"
              [ngModel]="deliveryStatusFilter()"
              (ngModelChange)="deliveryStatusFilter.set($event)"
            >
              <option value="">All</option>
              <option value="packed">Packed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
              <option value="failed">Failed</option>
            </select>
          </div>

          <!-- Payment Status -->
          <div class="filter-item">
            <label>Payment</label>
            <select
              class="filter-select"
              [ngModel]="paymentStatusFilter()"
              (ngModelChange)="paymentStatusFilter.set($event)"
            >
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
              <option value="failed">Failed</option>
              <option value="refunded">Refunded</option>
            </select>
          </div>

          <!-- From Date -->
          <div class="filter-item">
            <label>From</label>
            <input
              type="date"
              class="filter-select"
              [ngModel]="dateFromFilter()"
              (ngModelChange)="dateFromFilter.set($event)"
            />
          </div>

          <!-- To Date -->
          <div class="filter-item">
            <label>To</label>
            <input
              type="date"
              class="filter-select"
              [ngModel]="dateToFilter()"
              (ngModelChange)="dateToFilter.set($event)"
            />
          </div>

        </div>

        <!-- Actions -->
        <div class="filter-actions">
          <button class="filter-btn apply" (click)="applyFilters()">
            <i class="bi bi-funnel"></i> Apply
          </button>
          <button class="filter-btn clear" (click)="clearFilters()">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>

      </div>


      <!-- Table -->
      <div class="table-container">
        <table class="table modern-table">
          <thead>
            <tr>
              <th (click)="updateSort('orderNumber')">Order #</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Date</th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            @for (order of filteredOrders(); track order.id) {
              <tr>
                <td>
                  <strong>{{ order.orderNumber }}</strong>
                  <div class="sub">{{ order.paymentMethod | uppercase }}</div>
                </td>

                <td>
                  <div class="fw-bold">{{ order?.user?.username }}</div>
                  <div class="sub">{{ order?.user?.email }}</div>
                  <div class="sub">{{ order?.user?.phone }}</div>
                </td>

                <td>
                  <span class="badge bg-secondary">{{ order?.items?.length }} items</span>
                  <div class="sub small">
                    @for (item of order?.items?.slice(0, 2); track item.name) {
                      {{ item?.name }} ({{ item?.quantity }})
                    }
                    @if(order.items.length > 2) {
                      <span class="text-muted">+{{ order.items.length - 2 }} more</span>
                    }
                  </div>
                </td>

                <td class="text-end">
                  <strong>â‚¹{{ order?.totalAmount }}</strong>
                </td>

                <td class="status-col">

                  <!-- Status Badge -->
                  <span class="badge status-badge" [ngClass]="order.orderStatus">
                    {{ order.orderStatus | uppercase }}
                  </span>

                  <!-- Status Dropdown -->
                  <select 
                    class="status-select"
                    [ngModel]="order?.orderStatus"
                    #status (change)="updateOrderStatus(order.id, status.value)"
                  >
                    @for (item of orderStatuses; track $index) {
                      <option [value]="item.key" [selected]="item.key === order.orderStatus">{{ item.value }}</option>
                    }
                  </select>
                </td>

                <td>
                  <span class="badge status-badge" [ngClass]="order.paymentStatus">
                    {{ order.paymentStatus | titlecase }}
                  </span>
                </td>

                <td>{{ order.createdAt | date:'short' }}</td>

                <td>
                  <button class="btn btn-outline-primary btn-sm"
                    (click)="viewOrderDetails(order)">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>

              </tr>
            } @empty {
              <tr>
                <td colspan="8" class="empty-state">
                  <i class="bi bi-cart-x"></i>
                  <p>No orders found</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container">
        <button class="page-btn" (click)="onPageChange(currentPage() - 1)" [disabled]="currentPage() === 1">Prev</button>
        <span>{{ currentPage() }} / {{ totalPages() }}</span>
        <button class="page-btn" (click)="onPageChange(currentPage() + 1)" [disabled]="currentPage() === totalPages()">Next</button>
      </div>

      }

    </div> <!-- card-body -->
  </div> <!-- card -->
</div>
