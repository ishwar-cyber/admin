<div class="order-page container-fluid py-3">

  <!-- Header -->
  <div class="page-header card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="title">Order Management</h3>
        <p class="subtitle">Track, manage and update orders with real-time status</p>
      </div>

      <button class="btn refresh-btn" (click)="loadOrders()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Stats -->
<div class="row g-3 stats-row">
  @for (item of stats(); track item.label) {
    <div class="col-lg-2 col-md-3 col-6">
      <div class="stat-box {{ item.class }}">
        <div class="value">
          <i class="bi {{ item.icon }} icon"></i>
          {{ item.value() }}
        </div>
        <div class="label">{{ item.label }}</div>
      </div>
    </div>
  }
</div>
  <!-- Main Card -->
  <div class="card modern-card mt-4">
    <div class="card-body">
      <!-- Loading -->
      @if (loading()) {
        <div class="loading-container">
          <div class="spinner-border text-primary"></div>
        </div>
      } @else {
      <!-- Modern Filters Panel -->
      <div class="filter-toggle">
        <button (click)="showFilters.set(!showFilters())" class="btn btn-primary">
          <i class="bi"  [class.bi-chevron-up]="showFilters()" [class.bi-chevron-down]="!showFilters()"></i>
          Filters
        </button>
      </div>

      @if(showFilters()){
        <div class="filters-panel">

          <!-- Search box -->
          <div class="filters-grid">
            <div class="filter-item">
              <label>Search</label>
              <div class="input-icon">
                <i class="bi bi-search"></i>
                <input 
                  type="text"
                  placeholder="Search Order #, Customer..."
                  [ngModel]="searchTerm()"
                  (ngModelChange)="searchTerm.set($event)"
                />
              </div>
            </div>

            <!-- Auto generated filters -->
            @for (f of filterConfig(); track f.key) {
              <div class="filter-item">
                <label>{{ f.label }}</label>

              @if (f.type === 'select') {
                <select 
                  [ngModel]="filterSignals[f.key]()" 
                  (ngModelChange)="filterSignals[f.key].set($event)"
                >
                  @for (o of f.options; track o.value) {
                    <option [value]="o.value">{{ o.label }}</option>
                  }
                </select>
              }
              @if (f.type === 'date') {
                <input 
                  type="date"
                  [ngModel]="filterSignals[f.key]()"
                  (ngModelChange)="filterSignals[f.key].set($event)"
                />
              }
              </div>
            }
          </div>

          <div class="filter-actions">
            <button class="apply" (click)="applyFilters()"><i class="bi bi-funnel"></i> Apply</button>
            <button class="clear" (click)="clearFilters()"><i class="bi bi-x-circle"></i> Clear</button>
          </div>

        </div>
      }

      <!-- Table -->
      <div class="table-container">
        <table class="table modern-table">
          <thead>
            <tr>
              <th (click)="updateSort('orderNumber')">Order #</th>
              <!-- <th>Customer</th> -->
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Payment</th>
              <!-- <th>Date</th> -->
              <th></th>
            </tr>
          </thead>

          <tbody>
            @for (order of filteredOrders(); track order.id) {
              <tr>
                <td>
                  <strong>{{ order.orderNumber }}</strong>
                  <div class="sub">{{ order.paymentMethod | uppercase }}</div>
                </td>

                <!-- <td>
                  <div class="fw-bold ">{{ order?.user?.username }}</div>
                  <div class="sub">{{ order?.user?.email }}</div>
                  <div class="sub">{{ order?.user?.phone }}</div>
                </td> -->

                <td class="width: 200px">
                  <span class="badge bg-secondary">{{ order?.items?.length }} items</span>
                  <div class="sub small ">
                    @for (item of order?.items?.slice(0, 2); track item.name) {
                     <div class="product-name"> {{ item?.name }} ({{ item?.quantity }}), </div>
                    }
                    @if(order.items.length > 2) {
                      <span class="text-muted">+{{ order.items.length - 2 }} more</span>
                    }
                  </div>
                </td>

                <td class="text-end">
                  <strong>â‚¹{{ order?.totalAmount }}</strong>
                </td>

                <td class="status-col">
                  <!-- Status Badge -->
                  <span class="badge status-badge"[ngClass]="selectedStatusMap()[order.id] || order.orderStatus">
                    {{ (selectedStatusMap()[order.id] || order.orderStatus) | uppercase }}
                  </span>

                  <select
                    class="status-select"
                    [ngModel]="selectedStatusMap()[order.id] || order.orderStatus"
                    (ngModelChange)="updateOrderStatus(order.id, $event, order)"
                  >
                    @for (item of orderStatuses; track item.key) {
                      <option [value]="item.key">{{ item.value }}</option>
                    }
                      <!-- EXTRA OPTION ONLY WHEN ORDER IS CANCELLED -->
                    @if(order.orderStatus === 'cancelled') {
                      <option value="refund" >Refund</option>
                    }
                  </select>
                </td>

                <td>
                  <span class="badge status-badge" [ngClass]="order.paymentStatus.toLowerCase()">
                    {{ order.paymentStatus | titlecase }}
                  </span>
                </td>

                <!-- <td>{{ order.createdAt | date:'short' }}</td> -->

                <td>
                  <button class="btn btn-outline-primary btn-sm"
                    (click)="viewOrderDetails(order)">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>

              </tr>
            } @empty {
              <tr>
                <td colspan="8" class="empty-state">
                  <i class="bi bi-cart-x"></i>
                  <p>No orders found</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container">
        <button class="page-btn" (click)="onPageChange(currentPage() - 1)" [disabled]="currentPage() === 1">Prev</button>
        <span>{{ currentPage() }} / {{ totalPages() }}</span>
        <button class="page-btn" (click)="onPageChange(currentPage() + 1)" [disabled]="currentPage() === totalPages()">Next</button>
      </div>

      }

    </div> <!-- card-body -->
  </div> <!-- card -->
</div>
